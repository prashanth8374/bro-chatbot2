<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Connect AI - Your Academic Companion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* CSS Variables for Theme */
        :root {
            /* Dark Mode (Default) */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e; /* Gradient end */
            --bg-app-overlay: rgba(30, 30, 30, 0.6); /* Increased transparency for animations */
            --bg-sidebar: rgba(15, 15, 15, 0.7); /* Increased transparency */
            --bg-header: rgba(25, 25, 25, 0.7); /* Increased transparency */
            --bg-message-user: rgba(255, 193, 7, 0.1); /* Golden tint, more transparent */
            --bg-message-bot: rgba(35, 35, 35, 0.5); /* More transparent */
            --bg-input: rgba(40, 40, 40, 0.6); /* More transparent */
            --bg-history-item: rgba(30, 30, 30, 0.6); /* More transparent */
            --bg-typing-indicator: rgba(35, 35, 35, 0.5); /* More transparent */
            --bg-suggestion: rgba(255, 193, 7, 0.08); /* Golden tint, more transparent */
            --bg-login-box: rgba(25, 25, 25, 0.6); /* More transparent */

            --text-primary: rgba(255, 255, 255, 0.9);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --text-accent: #FFD700; /* Golden color */
            --text-button-dark: #0a0a0a;

            --border-color: rgba(255, 215, 0, 0.15); /* More subtle golden border */
            --shadow-color-light: rgba(255, 215, 0, 0.25); /* More subtle golden shadow */
            --shadow-color-dark: rgba(0, 0, 0, 0.5); /* More subtle shadow */

            /* Three.js Particle color (for Chat App) */
            --particle-color-chat: #FFD700; /* Golden particles for chat app background */

            /* Falling Squares color (for Login page) */
            --square-color-login: #FFD700; /* Golden yellow for login squares */

            --accent-btn-bg: linear-gradient(135deg, #FFD700, #FFA000); /* Golden gradient */

            --status-online: #4ade80; /* Green */
        }

        /* Light Mode */
        body.light-mode {
            --bg-primary: #f0f2f5;
            --bg-secondary: #e0e2e5;
            --bg-tertiary: #d0d2d5;
            --bg-app-overlay: rgba(255, 255, 255, 0.7); /* Increased transparency for animations */
            --bg-sidebar: rgba(240, 240, 240, 0.7); /* Increased transparency */
            --bg-header: rgba(230, 230, 230, 0.7); /* Increased transparency */
            --bg-message-user: rgba(173, 216, 230, 0.25); /* Light blue tint, more transparent */
            --bg-message-bot: rgba(240, 240, 240, 0.6); /* More transparent */
            --bg-input: rgba(230, 230, 230, 0.7); /* More transparent */
            --bg-history-item: rgba(220, 220, 220, 0.6); /* More transparent */
            --bg-typing-indicator: rgba(230, 230, 230, 0.6); /* More transparent */
            --bg-suggestion: rgba(173, 216, 230, 0.2); /* Light blue tint, more transparent */
            --bg-login-box: rgba(240, 240, 240, 0.7); /* More transparent */

            --text-primary: #333;
            --text-secondary: #555;
            --text-tertiary: #888;
            --text-accent: #4682b4; /* Steel blue */
            --text-button-dark: #f0f2f5;

            --border-color: rgba(70, 130, 180, 0.2); /* More subtle */
            --shadow-color-light: rgba(70, 130, 180, 0.2); /* More subtle */
            --shadow-color-dark: rgba(0, 0, 0, 0.12); /* More subtle */

            /* Light mode specific for Three.js (Chat App) */
            --particle-color-chat: #4682b4; /* Steel blue for chat app Three.js background */

            /* Light mode specific for Falling Squares (Login page) */
            --square-color-login: #c0c0c0; /* Silver/light gray for login squares in light mode */
            --accent-btn-bg: linear-gradient(135deg, #4682b4, #5f9ea0); /* Steel blue gradient */
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
            overflow: hidden; /* Prevent scroll on body */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary); /* Base background for body */
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.5s ease; /* Smooth transition for theme change */
        }

        /* Three.js Canvas - NOW FOR MAIN CHAT APP */
        #threeJsCanvas {
            position: fixed; /* Fixed position to cover entire viewport */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; /* Behind all content */
            display: none; /* Controlled by JS to show only on chat app */
        }

        /* Falling Squares animation for the LOGIN PAGE background */
        .login-page-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -2; /* Even further behind login content */
            background: var(--bg-primary); /* Base color for the background behind squares */
            display: none; /* Controlled by JS to show only on login */
        }

        .login-page-background .square {
            position: absolute;
            background: var(--square-color-login);
            opacity: 0.3; /* Increased opacity for clarity */
            animation: squareFall 15s linear infinite;
        }

        @keyframes squareFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.3; /* Clearly visible */
            }
            80% {
                opacity: 0.3; /* Clearly visible */
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(360deg);
                opacity: 0;
            }
        }


        /* Full page container for all main UI components */
        .full-page-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Using flex to center content */
            justify-content: center;
            align-items: center;
            z-index: 1; /* Main container for app and overall background */
            overflow: hidden; /* Prevent scroll on this container */
            background: transparent; /* Allow specific backgrounds to show through */
        }

        /* Login Page Styles */
        .login-container {
            position: relative; /* Ensure it's positioned on top of overall background */
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; /* Takes full height of .full-page-container */
            width: 100%;
        }

        .login-box {
            background: var(--bg-login-box); /* Use transparent background */
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 15px 30px var(--shadow-color-dark);
            animation: loginSlideIn 1s ease-out;
            z-index: 1; /* Ensure it sits on top of full-page background */
            border: 1px solid var(--border-color); /* Subtle border for login */
        }

        @keyframes loginSlideIn {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h1 {
            color: var(--text-accent);
            font-size: 28px;
            margin-bottom: 8px;
            text-shadow: 0 0 15px var(--shadow-color-light);
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-accent);
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            box-shadow: 0 0 12px var(--shadow-color-light);
            background: var(--bg-input);
        }

        .form-group input::placeholder {
            color: var(--text-tertiary);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-btn-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-button-dark);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-color-light);
        }

        /* Chat Container Styles */
        .chat-app {
            display: none; /* Hidden by default, shown by JS */
            position: relative; /* Crucial for z-index and clipping children */
            z-index: 10; /* Make sure it's above other elements */
            height: 100vh;
            width: 100vw;
            background: var(--bg-app-overlay); /* Semi-transparent overlay for app */
            backdrop-filter: blur(15px);
            border-radius: 0;
            box-shadow: none;
            animation: chatSlideIn 1s ease-out;
            overflow: hidden;
            display: grid;
            grid-template-columns: 280px 1fr;
            border: none;
        }


        @media (max-width: 768px) {
            .chat-app {
                height: 100vh;
                width: 100vw;
                border-radius: 0;
                grid-template-columns: 1fr;
            }
        }

        @keyframes chatSlideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Sidebar Styles */
        .sidebar {
            background: var(--bg-sidebar);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            border-right: 1px solid rgba(255,255,255,0.05); /* Subtle separator */
        }
        body.light-mode .sidebar {
            border-right: 1px solid rgba(0,0,0,0.05);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 20px;
            color: var(--text-accent);
        }

        .new-chat-btn {
            background: var(--text-accent);
            color: var(--text-button-dark);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .new-chat-btn:hover {
            background: var(--accent-btn-bg);
            transform: translateY(-1px);
            color: var(--text-button-dark);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1); /* Dark scrollbar track */
            border-radius: 10px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1); /* Light scrollbar thumb */
            border-radius: 10px;
            border: 2px solid transparent;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Light mode scrollbar */
        body.light-mode .chat-history::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }
        body.light-mode .chat-history::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
        }
        body.light-mode .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }


        .history-item {
            background: var(--bg-history-item);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: rgba(50, 50, 50, 0.6);
            border: 1px solid var(--border-color);
        }
        body.light-mode .history-item:hover {
            background: rgba(200, 200, 200, 0.6);
        }


        .history-item.active {
            background: var(--text-accent);
            color: var(--text-button-dark);
            font-weight: 600;
            border: 1px solid var(--text-accent);
        }

        .history-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .history-item-actions {
            display: none;
            gap: 5px;
            margin-left: 10px;
        }

        .history-item:hover .history-item-actions {
            display: flex;
        }

        .history-item-actions button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 3px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .history-item-actions button:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        body.light-mode .history-item-actions button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Chat Area */
        .main-chat-area {
            display: flex;
            flex-direction: column;
            flex: 1; /* Crucial for filling parent vertically */
            min-height: 0; /* Important for flex items with overflow */
        }

        /* Header */
        .header {
            background: var(--bg-header);
            color: var(--text-accent);
            padding: 15px 20px;
            box-shadow: 0 2px 10px var(--shadow-color-dark);
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 5px; /* Space between elements */
            flex-shrink: 0; /* Prevent header from shrinking */
            border-bottom: 1px solid rgba(255,255,255,0.05); /* Subtle separator */
        }
        body.light-mode .header {
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .header .top-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Take full width of header */
        }
        .header .top-line .left-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header h1 {
            font-size: 22px;
            margin: 0; /* Remove default margin */
            font-weight: 600;
            color: var(--text-accent);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 5px;
        }

        .user-info {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right; /* Align to right within its container */
            line-height: 1.3;
        }
        body.light-mode .user-info {
            color: var(--text-secondary);
        }

        .status-indicator {
            display: inline-block;
            width: 7px;
            height: 7px;
            background: var(--status-online);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px var(--status-online);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Chat Area (where messages and animations inside chatbot go) */
        .chat-container {
            flex: 1; /* Allows it to take available space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Crucial for clipping internal animations */
            position: relative; /* Set positioning context for children animations */
            background: transparent; /* Let animations show through */
            min-height: 0; /* Important for flex items with overflow */
        }

        .messages {
            flex: 1; /* Allow messages to take up available space */
            overflow-y: auto; /* Enable scrolling for messages */
            padding: 20px;
            scroll-behavior: smooth;
            background: transparent; /* Crucial: let animations show through */
            position: relative;
            z-index: 1; /* Messages should be on top of animations */
            min-height: 0; /* Important for flex items with overflow */
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }
        .messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px solid transparent;
        }
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }
        body.light-mode .messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }
        body.light-mode .messages::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
        }
        body.light-mode .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        .message {
            margin-bottom: 18px;
            display: flex;
            align-items: flex-start;
            animation: messageSlideIn 0.5s ease-out;
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message.user .message {
            animation: messageSlideInUser 0.5s ease-out;
        }

        @keyframes messageSlideInUser {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 15px;
            margin: 0 10px;
            flex-shrink: 0;
            box-shadow: 0 0 10px var(--shadow-color-light); /* Golden glow for avatar */
            border: 1px solid var(--border-color); /* Golden border for avatar */
        }

        .user .message-avatar {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
        }

        .bot .message-avatar {
            background: linear-gradient(135deg, #a0522d, #8b4513); /* Sienna/Chocolate for bot */
            color: white;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.4); /* Brownish glow for bot */
            border: 1px solid rgba(139, 69, 19, 0.2);
        }
        body.light-mode .bot .message-avatar {
            background: linear-gradient(135deg, #778899, #6a809b); /* Slate gray for bot */
            box-shadow: 0 0 10px rgba(105, 120, 135, 0.3);
            border: 1px solid rgba(105, 120, 135, 0.1);
        }


        .message-content {
            max-width: 65%;
            padding: 12px 18px;
            border-radius: 15px;
            line-height: 1.5;
            position: relative;
            backdrop-filter: blur(8px);
            font-size: 15px;
            color: var(--text-primary);
        }

        .user .message-content {
            background: var(--bg-message-user);
            border-bottom-right-radius: 8px;
            border: 1px solid var(--border-color); /* Golden border */
        }

        .bot .message-content {
            background: var(--bg-message-bot);
            border-bottom-left-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Lighter border */
        }
        body.light-mode .user .message-content {
            background: var(--bg-message-user);
            border: 1px solid var(--border-color);
        }
        body.light-mode .bot .message-content {
            background: var(--bg-message-bot);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }


        .timestamp {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 6px;
            text-align: right;
            color: var(--text-secondary);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            background: var(--bg-typing-indicator);
            border-radius: 15px;
            border-bottom-left-radius: 8px;
            margin-left: 50px;
            width: fit-content;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 18px;
        }
        body.light-mode .typing-indicator {
            border: 1px solid rgba(0, 0, 0, 0.08);
        }


        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .dot {
            width: 7px;
            height: 7px;
            background: var(--text-accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
            box-shadow: 0 0 8px var(--shadow-color-light);
        }

        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0) scale(1); }
            30% { transform: translateY(-8px) scale(1.2); }
        }

        /* Input Area (Search Bar) */
        .input-area {
            padding: 15px 20px;
            background: var(--bg-header); /* Use header background, which is transparent */
            backdrop-filter: blur(10px);
            flex-shrink: 0; /* Crucial: prevent it from shrinking */
            border-top: 1px solid rgba(255,255,255,0.05); /* Subtle separator */
        }
        body.light-mode .input-area {
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            background: var(--bg-input);
            border-radius: 25px;
            padding: 6px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 10px rgba(0,0,0,0.15); /* Subtle shadow for input */
            border: 1px solid rgba(255,255,255,0.05); /* Subtle border */
        }
        body.light-mode .input-container {
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .input-container:focus-within {
            box-shadow: 0 0 15px var(--shadow-color-light);
            transform: translateY(-1px);
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px 15px;
            background: transparent;
            font-size: 15px;
            resize: none;
            max-height: 100px;
            min-height: 20px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        #messageInput::placeholder {
            color: var(--text-tertiary);
        }

        .input-actions {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        #attachButton {
            background: rgba(255, 215, 0, 0.15); /* Golden tinted */
            color: var(--text-accent);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.15);
        }

        #attachButton:hover {
            transform: scale(1.1);
            background: rgba(255, 215, 0, 0.3);
        }
        body.light-mode #attachButton {
            background: rgba(70, 130, 180, 0.15);
            color: var(--text-accent);
            box-shadow: 0 0 10px rgba(70, 130, 180, 0.15);
        }
        body.light-mode #attachButton:hover {
            background: rgba(70, 130, 180, 0.3);
        }

        #sendButton {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px var(--shadow-color-light);
        }

        #sendButton:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 4px 15px var(--shadow-color-light);
        }

        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
        }

        .welcome-message h2 {
            color: var(--text-accent);
            margin-bottom: 12px;
            font-size: 26px;
            text-shadow: 0 0 15px var(--shadow-color-light);
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .suggestion {
            background: var(--bg-suggestion);
            color: var(--text-accent);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            /* New: Initial state for animation */
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }

        /* Animation for suggestions appearing */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stagger animation for multiple suggestions */
        .suggestion:nth-child(1) { animation-delay: 0.1s; }
        .suggestion:nth-child(2) { animation-delay: 0.2s; }
        .suggestion:nth-child(3) { animation-delay: 0.3s; }
        .suggestion:nth-child(4) { animation-delay: 0.4s; }
        .suggestion:nth-child(5) { animation-delay: 0.5s; }
        .suggestion:nth-child(6) { animation-delay: 0.6s; }
        /* Add more as needed based on max number of suggestions */


        .suggestion:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px var(--shadow-color-light);
            background: rgba(255, 193, 7, 0.1);
        }
        body.light-mode .suggestion {
            background: var(--bg-suggestion);
            border: 1px solid var(--border-color);
        }
        body.light-mode .suggestion:hover {
            background: rgba(173, 216, 230, 0.2);
            box-shadow: 0 6px 20px var(--shadow-color-light);
        }

        /* Theme Toggle */
        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: auto; /* Push to bottom in sidebar */
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            justify-content: center; /* Center horizontally in sidebar */
            flex-shrink: 0; /* Prevent it from shrinking */
        }
        body.light-mode .theme-toggle-container {
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .theme-toggle-container span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        body.light-mode .slider {
            background-color: #ccc; /* Ensure light mode slider is grey */
        }
        body.light-mode input:checked + .slider {
            background-color: var(--text-accent); /* Blue for light mode */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--text-accent); /* Golden for dark mode, Blue for light mode */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--text-accent);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-app {
                height: 100vh;
                width: 100vw;
                border-radius: 0;
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .sidebar.active {
                display: flex;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 20;
            }

            .header {
                flex-direction: column;
                padding-top: 10px;
                padding-bottom: 10px;
                gap: 5px; /* Adjust gap for smaller screens */
            }
            .header .top-line {
                flex-direction: row; /* Keep elements in a row */
                justify-content: space-between;
                width: 100%;
            }

            .header h1 {
                font-size: 18px;
            }

            .user-info {
                position: static;
                transform: none;
                margin-top: 0; /* Remove top margin */
                text-align: center;
                width: 100%;
            }

            .theme-toggle-container {
                position: static;
                transform: none;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
                border-top: none; /* Remove border if it's not at the bottom of sidebar */
                padding-top: 0;
            }

            .login-box {
                margin: 15px;
                padding: 25px;
            }

            .message-content {
                max-width: 80%;
            }

            .input-container {
                flex-wrap: nowrap;
            }
        }

        /* Mood/Topic Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Above everything else */
            backdrop-filter: blur(8px);
        }

        .mood-topic-modal {
            background: var(--bg-app-overlay);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px var(--shadow-color-dark);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid var(--border-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .mood-topic-modal h2 {
            color: var(--text-accent);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .mood-options, .topic-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mood-option, .topic-option {
            background: var(--bg-suggestion);
            color: var(--text-accent);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .mood-option:hover, .topic-option:hover, .mood-option.selected, .topic-option.selected {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 15px var(--shadow-color-light);
            background: var(--accent-btn-bg); /* Use accent color for selected */
            color: var(--text-button-dark);
        }
        body.light-mode .mood-option:hover, body.light-mode .topic-option:hover, body.light-mode .mood-option.selected, body.light-mode .topic-option.selected {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
        }

        .modal-buttons {
            margin-top: 20px;
        }

        .modal-buttons button {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .modal-buttons button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Generic Modal (for alerts, confirms, prompts) */
        .generic-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than mood/topic modal */
            backdrop-filter: blur(8px);
        }
        .generic-modal-content {
            background: var(--bg-app-overlay);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px var(--shadow-color-dark);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .generic-modal-content h3 {
            color: var(--text-accent);
            margin-bottom: 15px;
            font-size: 22px;
        }
        .generic-modal-content p {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        .generic-modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            margin-bottom: 20px;
        }
        .generic-modal-content input[type="text"]::placeholder {
            color: var(--text-tertiary);
        }
        .generic-modal-buttons button {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.3s ease, transform 0.3s ease;
            margin: 0 5px;
        }
        .generic-modal-buttons button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .generic-modal-buttons .cancel-btn {
            background: var(--bg-history-item); /* A slightly darker subtle background */
            color: var(--text-primary);
        }
        .generic-modal-buttons .cancel-btn:hover {
            background: rgba(50, 50, 50, 0.6);
        }
        body.light-mode .generic-modal-buttons .cancel-btn {
            background: var(--bg-input);
            color: var(--text-primary);
        }
        body.light-mode .generic-modal-buttons .cancel-btn:hover {
            background: rgba(230, 230, 230, 0.8);
        }
        .action-button {
            background: var(--accent-btn-bg);
            color: var(--text-button-dark);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px var(--shadow-color-light);
        }
        .action-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <canvas id="threeJsCanvas"></canvas> <div class="login-page-background" id="loginPageBackground"></div> <div class="full-page-container">
        <div class="login-container" id="loginPage">
            <div class="login-box">
                <div class="login-header">
                    <h1>🎓 Campus Connect AI</h1>
                    <p>Your academic companion for college success!</p>
                </div>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="userName">Full Name</label>
                        <input type="text" id="userName" name="userName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="rollNumber">Roll Number</label>
                        <input type="text" id="rollNumber" name="rollNumber" placeholder="Enter your roll number" required>
                    </div>
                    <button type="submit" class="login-btn">Enter Campus Portal 🎓</button>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="moodTopicModal" style="display: none;">
            <div class="mood-topic-modal">
                <h2 id="modalTitleMoodTopic">How are you feeling today, <span id="modalUserName"></span>?</h2>
                <div class="mood-options">
                    <div class="mood-option" data-mood="happy">😊 Happy</div>
                    <div class="mood-option" data-mood="stressed">😓 Stressed</div>
                    <div class="mood-option" data-mood="confused">😕 Confused</div>
                    <div class="mood-option" data-mood="motivated">⚡ Motivated</div>
                    <div class="mood-option" data-mood="curious">🤔 Curious</div>
                </div>

                <h2>What topic do you want to chat about?</h2>
                <div class="topic-options">
                    <div class="topic-option" data-topic="general">General Chat 💬</div>
                    <div class="topic-option" data-topic="math">Math 🧮</div>
                    <div class="topic-option" data-topic="science">Science 🔬</div>
                    <div class="topic-option" data-topic="programming">Programming 💻</div>
                    <div class="topic-option" data-topic="history">History 📜</div>
                    <div class="topic-option" data-topic="college life">College Life 🎓</div>
                    <div class="topic-option" data-topic="exam prep">Exam Prep 📝</div>
                </div>
                <div class="modal-buttons">
                    <button onclick="startChatFromModal()">Start Chat</button>
                </div>
            </div>
        </div>

        <div id="genericModal" class="generic-modal-overlay" style="display: none;">
            <div class="generic-modal-content">
                <h3 id="genericModalTitle"></h3>
                <p id="genericModalMessage"></p>
                <div id="genericModalInputContainer" style="display: none;">
                    <input type="text" id="genericModalInput" placeholder="" />
                </div>
                <div class="generic-modal-buttons">
                    <button id="genericModalConfirmBtn">OK</button>
                    <button id="genericModalCancelBtn" style="display: none;">Cancel</button>
                </div>
            </div>
        </div>


        <div class="chat-app" id="chatApp">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2>History</h2>
                    <button class="new-chat-btn" onclick="startNewChat()">+ New Chat</button>
                </div>
                <div class="chat-history" id="chatHistory">
                </div>
                <div class="theme-toggle-container">
                    <span>Dark Mode</span>
                    <label class="switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider round"></span>
                    </label>
                    <span>Light Mode</span>
                </div>
                <div class="user-info" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <div id="welcomeUserSidebar"></div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-chat-area">
                <div class="header">
                    <div class="top-line">
                        <p class="left-status">
                            <span class="status-indicator"></span>Campus Connect AI
                        </p>
                        <div class="user-info" id="userInfo">
                            <div id="welcomeUserHeader"></div>
                        </div>
                    </div>
                    <h1>Your personalized academic assistant</h1>
                </div>

                <div class="chat-container" id="chatContainer">
                    <div class="messages" id="messages">
                    </div>
                    <div class="action-buttons-container">
                        <button id="summarizeChatBtn" class="action-button">✨ Summarize Chat</button>
                        <button id="creativePromptBtn" class="action-button">💡 Creative Prompt</button>
                        <button id="changeBackgroundBtn" class="action-button">🎨 Change Chat Background</button>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf,.txt" onchange="handleFileUpload(event)">
                        <button id="attachButton" onclick="document.getElementById('fileInput').click()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <textarea
                            id="messageInput"
                            placeholder="Ask about studies, campus life, or anything else..."
                            rows="1"
                            onkeypress="handleKeyPress(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button id="voiceBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                        <button id="sendButton" onclick="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set the worker source for pdf.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        }

        let currentUser = null;
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let currentChatId = null;
        let selectedMood = '';
        let selectedTopic = '';
        let uploadedDocumentText = ''; // Stores text from uploaded PDF/TXT
        let audioEnabled = false; // New: for speech synthesis

        // Three.js Global Variables (for Chat App background)
        let scene, camera, renderer, particles, particleMaterial, particleGeometry;
        let mouseX = 0, mouseY = 0;
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;

        // Falling Squares Global Variable (for Login Page background)
        let squareInterval;

        // Generic Modal Elements (for alerts, confirms, prompts)
        const genericModal = document.getElementById("genericModal");
        const genericModalTitle = document.getElementById("genericModalTitle");
        const genericModalMessage = document.getElementById("genericModalMessage");
        const genericModalConfirmBtn = document.getElementById("genericModalConfirmBtn");
        const genericModalCancelBtn = document.getElementById("genericModalCancelBtn");
        const genericModalInputContainer = document.getElementById("genericModalInputContainer");
        const genericModalInput = document.getElementById("genericModalInput");

        // --- Custom Generic Modal Functions ---
        function showAlert(title, message) {
            return new Promise(resolve => {
                genericModalTitle.textContent = title;
                genericModalMessage.textContent = message;
                genericModalInputContainer.style.display = 'none';
                genericModalConfirmBtn.textContent = 'OK';
                genericModalCancelBtn.style.display = 'none';
                genericModal.style.display = 'flex';

                const confirmHandler = () => {
                    genericModal.style.display = 'none';
                    genericModalConfirmBtn.removeEventListener('click', confirmHandler);
                    resolve(true);
                };
                genericModalConfirmBtn.addEventListener('click', confirmHandler);
            });
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                genericModalTitle.textContent = title;
                genericModalMessage.textContent = message;
                genericModalInputContainer.style.display = 'none';
                genericModalConfirmBtn.textContent = 'Yes';
                genericModalCancelBtn.textContent = 'No';
                genericModalCancelBtn.style.display = 'inline-block';
                genericModal.style.display = 'flex';

                const confirmHandler = () => {
                    genericModal.style.display = 'none';
                    genericModalConfirmBtn.removeEventListener('click', confirmHandler);
                    genericModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };
                const cancelHandler = () => {
                    genericModal.style.display = 'none';
                    genericModalConfirmBtn.removeEventListener('click', confirmHandler);
                    genericModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };
                genericModalConfirmBtn.addEventListener('click', confirmHandler);
                genericModalCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        function showPrompt(title, message, placeholder = "") {
            return new Promise(resolve => {
                genericModalTitle.textContent = title;
                genericModalMessage.textContent = message;
                genericModalInput.value = '';
                genericModalInput.placeholder = placeholder;
                genericModalInputContainer.style.display = 'block';
                genericModalConfirmBtn.textContent = 'Submit';
                genericModalCancelBtn.textContent = 'Cancel';
                genericModalCancelBtn.style.display = 'inline-block';
                genericModal.style.display = 'flex';

                const submitHandler = () => {
                    genericModal.style.display = 'none';
                    genericModalConfirmBtn.removeEventListener('click', submitHandler);
                    genericModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(genericModalInput.value.trim());
                };
                const cancelHandler = () => {
                    genericModal.style.display = 'none';
                    genericModalConfirmBtn.removeEventListener('click', submitHandler);
                    genericModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(null); // Resolve with null if cancelled
                };
                genericModalConfirmBtn.addEventListener('click', submitHandler);
                genericModalCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        // Theme Toggle Logic
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light-mode') {
            body.classList.add('light-mode');
            themeToggle.checked = true;
        } else {
            body.classList.remove('light-mode');
            themeToggle.checked = false;
        }

        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light-mode');
                // Adjust Three.js particle color for light mode (on chat app)
                if (particleMaterial) {
                    particleMaterial.color.set(new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--particle-color-chat')));
                }
                // Re-render falling squares for login page to apply new square color
                if (document.getElementById('loginPage').style.display === 'flex') {
                    createFallingSquares();
                }
            } else {
                body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark-mode');
                // Adjust Three.js particle color for dark mode (on chat app)
                if (particleMaterial) {
                    particleMaterial.color.set(new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--particle-color-chat')));
                }
                // Re-render falling squares for login page to apply new square color
                if (document.getElementById('loginPage').style.display === 'flex') {
                    createFallingSquares();
                }
            }
        });


        // Initialize Three.js background for the MAIN CHAT APP
        function initThreeJsBackground() {
            // Only initialize if not already initialized
            if (scene && camera && renderer) {
                // Ensure canvas is visible if re-initializing for chat app
                document.getElementById('threeJsCanvas').style.display = 'block';
                return;
            }

            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            const threeJsCanvas = document.getElementById('threeJsCanvas');
            if (!threeJsCanvas) { // Create if it doesn't exist (should always exist in HTML)
                const newCanvas = renderer.domElement;
                newCanvas.id = 'threeJsCanvas';
                document.body.insertBefore(newCanvas, document.body.firstChild);
            } else {
                // Replace existing canvas if it's there but not the one from renderer
                if (threeJsCanvas.parentNode && threeJsCanvas.parentNode.nodeType === 1) { // Check if parent is an Element
                    threeJsCanvas.parentNode.replaceChild(renderer.domElement, threeJsCanvas);
                    renderer.domElement.id = 'threeJsCanvas'; // Reassign ID after replacement
                } else {
                    // Fallback if parent is null or not an element (shouldn't happen with fixed position)
                    document.body.insertBefore(renderer.domElement, document.body.firstChild);
                    renderer.domElement.id = 'threeJsCanvas';
                }
            }

            // Particles
            particleGeometry = new THREE.BufferGeometry();
            const vertices = [];
            // Increased number of particles and size for better visibility
            for (let i = 0; i < 2000; i++) { // Default 2000 particles (increased from 1000)
                const x = (Math.random() - 0.5) * 25; // Increased spread
                const y = (Math.random() - 0.5) * 25; // Increased spread
                const z = (Math.random() - 0.5) * 25; // Increased spread
                vertices.push(x, y, z);
            }
            particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            particleMaterial = new THREE.PointsMaterial({
                color: new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--particle-color-chat')), // Dynamic color based on theme
                size: 0.35, // Increased size for clarity
                transparent: true,
                opacity: 0.8, // Increased opacity
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);

            // Animation loop
            animateThreeJsBackground();

            // Event listeners for responsiveness and interaction
            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
        }

        // Animation loop for Three.js
        function animateThreeJsBackground() {
            requestAnimationFrame(animateThreeJsBackground);

            if (particles) {
                particles.rotation.x += 0.0007; // Slightly faster rotation
                particles.rotation.y += 0.0015; // Slightly faster rotation
            }

            if (camera) {
                camera.position.x += ((mouseX / windowHalfX) * 5 - camera.position.x) * 0.05;
                camera.position.y += ((-mouseY / windowHalfY) * 5 - camera.position.y) * 0.05;
                camera.lookAt(scene.position);
            }

            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Handle window resize for Three.js
        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;
            if (renderer && camera) {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
        }

        // Handle mouse move for Three.js
        function onDocumentMouseMove(event) {
            mouseX = event.clientX - windowHalfX;
            mouseY = event.clientY - windowHalfY;
        }

        // Update Three.js background based on a theme (for chat app)
        document.getElementById('changeBackgroundBtn').addEventListener('click', async () => {
            if (!scene || !camera || !renderer) {
                showAlert("Background Error", "Three.js background not initialized. Please reload the page if issue persists.");
                return;
            }

            const theme = await showPrompt(
                "Change Chat Background Theme",
                "What kind of background theme would you like for the chat app? (e.g., 'space', 'ocean waves', 'cyberpunk city')",
                "Enter theme (e.g., 'abstract', 'futuristic')"
            );

            if (!theme) {
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage("Chat background theme change cancelled.", 'bot', botTimestamp, true);
                return;
            }

            showTypingIndicator(); // Show indicator for AI processing

            try {
                const promptForGemini = `Generate 3-5 keywords and a single color hex code (e.g., "#RRGGBB") for a Three.js abstract particle background based on the theme: "${theme}". The response MUST be ONLY a JSON object with "keywords" (array of strings) and "color" (hex string). Do NOT include any markdown formatting like \`\`\`json.`;
                const rawResponse = await getGeminiResponseDirectly(promptForGemini);

                let jsonString = rawResponse.trim();
                if (jsonString.startsWith('```json')) {
                    jsonString = jsonString.substring(7);
                }
                if (jsonString.endsWith('```')) {
                    jsonString = jsonString.substring(0, jsonString.length - 3);
                }
                jsonString = jsonString.trim();

                let themeData;
                try {
                    themeData = JSON.parse(jsonString);
                } catch (jsonError) {
                    console.error("Error parsing JSON from Gemini API:", jsonError, "Raw response:", rawResponse);
                    await showAlert("AI Response Error", "Received an invalid background theme from AI. Please try again with a different prompt.");
                    return;
                }

                if (themeData && themeData.color) {
                    particleMaterial.color.set(themeData.color);

                    const newVertices = [];
                    let numParticles = 2000; // Base particles
                    let particleSize = 0.35; // Base size
                    let particleSpread = 25; // Base spread

                    if (themeData.keywords) {
                        if (themeData.keywords.includes('space') || themeData.keywords.includes('stars') || themeData.keywords.includes('galaxy')) {
                            numParticles = 6000; // More particles for space
                            particleSize = 0.4; // Slightly larger stars
                            particleSpread = 60; // Wider spread
                        } else if (themeData.keywords.includes('waves') || themeData.keywords.includes('liquid') || themeData.keywords.includes('fluid') || themeData.keywords.includes('ocean')) {
                            numParticles = 1000; // Fewer, subtle particles
                            particleSize = 0.2; // Smaller for liquid effect
                            particleSpread = 20;
                        } else if (themeData.keywords.includes('cyberpunk') || themeData.keywords.includes('neon') || themeData.keywords.includes('city')) {
                            numParticles = 3000;
                            particleSize = 0.3;
                            particleSpread = 40;
                        } else if (themeData.keywords.includes('calm') || themeData.keywords.includes('minimal')) {
                            numParticles = 800;
                            particleSize = 0.25;
                            particleSpread = 15;
                        }
                    }

                    for (let i = 0; i < numParticles; i++) {
                        const x = (Math.random() - 0.5) * particleSpread;
                        const y = (Math.random() - 0.5) * particleSpread;
                        const z = (Math.random() - 0.5) * particleSpread;
                        newVertices.push(x, y, z);
                    }
                    particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(newVertices, 3));
                    particleGeometry.attributes.position.needsUpdate = true;
                    particleMaterial.size = particleSize;

                    const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    addMessage(`Chat background updated to a "${theme}" theme.`, 'bot', botTimestamp, true);
                } else {
                    const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    addMessage("AI response missing color or keywords for background. Using current theme default.", 'bot', botTimestamp, true);
                }
            } catch (error) {
                console.error("Error updating Three.js chat background:", error);
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage("Failed to update chat background. There was an error with the AI response.", 'bot', botTimestamp, true);
            } finally {
                hideTypingIndicator();
            }
        });


        // Function to create and manage falling squares for LOGIN PAGE
        function createFallingSquares() {
            const container = document.getElementById('loginPageBackground');
            if (!container) return;

            // Clear existing squares
            container.innerHTML = '';
            clearInterval(squareInterval); // Clear any existing interval

            const numSquares = 80; // Increased number of squares
            const minSize = 15; // Increased min size
            const maxSize = 50; // Increased max size
            const squareColor = getComputedStyle(document.documentElement).getPropertyValue('--square-color-login');

            for (let i = 0; i < numSquares; i++) {
                const square = document.createElement('div');
                square.className = 'square';
                const size = Math.random() * (maxSize - minSize) + minSize;
                const left = Math.random() * 100; // % from left
                const delay = Math.random() * 10; // seconds
                const duration = 10 + Math.random() * 10; // seconds

                square.style.width = `${size}px`;
                square.style.height = `${size}px`;
                square.style.left = `${left}%`;
                square.style.animationDelay = `${delay}s`;
                square.style.animationDuration = `${duration}s`;
                square.style.backgroundColor = squareColor; // Apply dynamic color
                container.appendChild(square);
            }
        }


        // Login handling
        function handleLogin(event) {
            event.preventDefault();
            const userName = document.getElementById('userName').value;
            const rollNumber = document.getElementById('rollNumber').value;

            currentUser = { name: userName, roll: rollNumber };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Hide login page elements
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('loginPageBackground').style.display = 'none'; // Hide falling squares
            clearInterval(squareInterval); // Stop square generation

            // Show mood/topic modal
            document.getElementById('modalUserName').textContent = userName.split(' ')[0];
            document.getElementById('moodTopicModal').style.display = 'flex';

            // Ensure chatApp and Three.js canvas are hidden at this stage
            document.getElementById('chatApp').style.display = 'none';
            document.getElementById('threeJsCanvas').style.display = 'none';
        }

        // Mood/Topic Selection Logic
        document.querySelectorAll('.mood-option').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.mood-option').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedMood = button.dataset.mood;
            });
        });

        document.querySelectorAll('.topic-option').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.topic-option').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedTopic = button.dataset.topic;
            });
        });

        function startChatFromModal() {
            if (!selectedMood) {
                showAlert('Mood Not Selected', 'Please select your mood before starting the chat.');
                return;
            }
            if (!selectedTopic) {
                showAlert('Topic Not Selected', 'Please select a topic before starting the chat.');
                return;
            }

            // Hide mood/topic modal
            document.getElementById('moodTopicModal').style.display = 'none';
            // Show chatApp
            document.getElementById('chatApp').style.display = 'grid';
            // Show Three.js canvas for chat app
            initThreeJsBackground();
            document.getElementById('threeJsCanvas').style.display = 'block';

            document.getElementById('welcomeUserHeader').innerHTML = `
                <strong>${currentUser.name}</strong><br>
                Roll: ${currentUser.roll}
            `;
            document.getElementById('welcomeUserSidebar').innerHTML = `
                <strong>${currentUser.name}</strong><br>
                Roll: ${currentUser.roll}
            `;

            if (chatHistory.length === 0) {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: []
                };
                chatHistory.unshift(newChat);
                currentChatId = newChat.id;
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                renderChatHistory();
                document.getElementById('messages').innerHTML = '';
            } else {
                loadChat(chatHistory[0].id);
            }

            const personalizedWelcome = generatePersonalizedWelcome(selectedMood, selectedTopic);
            const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            addMessage(personalizedWelcome, 'bot', botTimestamp, true);
            saveCurrentChatState({ content: personalizedWelcome, sender: 'bot', timestamp: botTimestamp });

            updateSuggestions(selectedTopic);
            scrollToBottom();
        }

        function updateSuggestions(topic) {
            const messagesContainer = document.getElementById('messages');
            let welcomeMsgDiv = messagesContainer.querySelector('.welcome-message');

            if (!welcomeMsgDiv) {
                welcomeMsgDiv = document.createElement('div');
                welcomeMsgDiv.className = 'welcome-message';
                messagesContainer.appendChild(welcomeMsgDiv);
            }
            welcomeMsgDiv.innerHTML = `
                <h2>Quick Start for ${topic.charAt(0).toUpperCase() + topic.slice(1)}!</h2>
                <p>Try these questions to get started:</p>
                <div class="suggestions"></div>
            `;

            const suggestionsContainer = welcomeMsgDiv.querySelector('.suggestions');
            let suggestions = [];
            switch(topic) {
                case 'math':
                    suggestions = ['Explain complex numbers', 'How to solve quadratic equations?', 'What is calculus?', 'Tips for math exams'];
                    break;
                case 'science':
                    suggestions = ['Explain photosynthesis', 'What are Newton\'s laws?', 'Tell me about climate change', 'Biology study tips'];
                    break;
                case 'programming':
                    suggestions = ['What is Python?', 'Explain data structures', 'Tips for debugging code', 'How to learn web development?'];
                    break;
                case 'history':
                    suggestions = ['Tell me about World War II', 'Who was Mahatma Gandhi?', 'Ancient civilizations facts', 'How to analyze historical sources?'];
                    break;
                case 'college life':
                    suggestions = ['Where is the library?', 'How to join a club?', 'Tips for managing college stress', 'What\'s on campus this week?'];
                    break;
                case 'exam prep':
                    suggestions = ['Best way to revise for exams?', 'How to manage exam anxiety?', 'Create a study schedule', 'Tips for essay exams'];
                    break;
                default: // General chat
                    suggestions = ['Give me study tips', 'How to improve grades?', 'Tips for presentations', 'What is the library timing?'];
                    break;
            }

            suggestions.forEach((text, index) => {
                const button = document.createElement('button');
                button.className = 'suggestion';
                button.textContent = text;
                button.onclick = () => sendSuggestion(text);
                button.style.animationDelay = `${0.1 * index}s`; // Stagger animation
                suggestionsContainer.appendChild(button);
            });
        }

        function generatePersonalizedWelcome(mood, topic) {
            const userName = currentUser.name.split(' ')[0];
            let greeting = `Hello, ${userName}! It's great to see you. `;

            switch(mood) {
                case 'happy':
                    greeting += "Glad to hear you're feeling good! Let's make this an even more productive session. ";
                    break;
                case 'stressed':
                    greeting += "I understand you're feeling stressed. Take a deep breath! I'm here to help lighten your academic load. ";
                    break;
                case 'confused':
                    greeting += "Feeling a bit confused? Don't worry, we'll clear things up together. ";
                    break;
                case 'motivated':
                    greeting += "Awesome to hear you're motivated! Let's channel that energy into some productive learning. ";
                    break;
                case 'curious':
                    greeting += "Curiosity is the key to knowledge! What mysteries shall we unravel today? ";
                    break;
                default:
                    greeting += "How can I best support your studies today? ";
            }

            switch(topic) {
                case 'math':
                    greeting += `Looks like you're ready to tackle some Math. What ${topic} concept should we explore?`;
                    break;
                case 'science':
                    greeting += `Ready for a dive into Science? What ${topic} question do you have?`;
                    break;
                case 'programming':
                    greeting += `Excited to code? Let's talk Programming. How can I help with your coding journey?`;
                    break;
                case 'history':
                    greeting += `Exploring History, are we? Which period or event sparks your interest?`;
                    break;
                case 'college life':
                    greeting += `Navigating College Life can be a lot. How can I assist with your campus queries?`;
                    break;
                case 'exam prep':
                    greeting += `It's Exam Prep time! Let's get you ready. What are you studying for?`;
                    break;
                default: // General chat
                    greeting += `What academic area or college life topic would you like to discuss?`;
                    break;
            }
            return greeting;
        }

        async function logout() {
            const confirmed = await showConfirm(
                "Logout Confirmation",
                "Are you sure you want to end your session and clear all data?"
            );
            if (confirmed) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('chatHistory');
                chatHistory = [];
                currentChatId = null;
                selectedMood = '';
                selectedTopic = '';
                uploadedDocumentText = ''; // Clear uploaded document text

                // Hide chat app
                document.getElementById('chatApp').style.display = 'none';
                // Hide Three.js canvas
                document.getElementById('threeJsCanvas').style.display = 'none';


                // Show login page
                document.getElementById('loginPage').style.display = 'flex';
                // Show falling squares for login page
                document.getElementById('loginPageBackground').style.display = 'block';
                createFallingSquares(); // Re-start squares animation


                document.getElementById('moodTopicModal').style.display = 'none';

                document.getElementById('loginForm').reset();
                document.getElementById('messages').innerHTML = '';
                renderChatHistory(); // Clear sidebar history
                scrollToBottom();
            }
        }

        // Chat history management
        function renderChatHistory() {
            const chatHistoryContainer = document.getElementById('chatHistory');
            chatHistoryContainer.innerHTML = '';

            chatHistory.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                historyItem.dataset.chatId = chat.id;
                historyItem.onclick = () => loadChat(chat.id);

                historyItem.innerHTML = `
                    <span class="history-item-title">${chat.title}</span>
                    <div class="history-item-actions">
                        <button onclick="editChatTitle(event, '${chat.id}')" title="Edit Chat">✏️</button>
                        <button onclick="deleteChat(event, '${chat.id}')" title="Delete Chat">🗑️</button>
                    </div>
                `;
                chatHistoryContainer.appendChild(historyItem);
            });
        }

        function startNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: []
            };
            chatHistory.unshift(newChat);
            currentChatId = newChat.id;
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderChatHistory();
            document.getElementById('messages').innerHTML = '';

            const welcomeMsgDiv = document.createElement('div');
            welcomeMsgDiv.className = 'welcome-message';
            welcomeMsgDiv.innerHTML = `
                <h2>🎓 Ready for a new academic adventure!</h2>
                <p>What can I help you with in this session?</p>
                <div class="suggestions" id="initialSuggestions">
                    <button class="suggestion" onclick="sendSuggestion('Give me study tips')">Give me study tips 📚</button>
                    <button class="suggestion" onclick="sendSuggestion('How to improve grades?')">How to improve grades? 📈</button>
                    <button class="suggestion" onclick="sendSuggestion('Tips for presentations')">Tips for presentations 🎤</button>
                </div>
            `;
            document.getElementById('messages').appendChild(welcomeMsgDiv);

            document.getElementById('messageInput').value = '';
            adjustTextareaHeight(document.getElementById('messageInput'));
            scrollToBottom();
            uploadedDocumentText = ''; // Clear uploaded document context for new chat
        }

        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chatHistory.find(c => c.id === chatId);
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = ''; // Clear messages before loading

            // Remove existing welcome message/suggestions
            const existingWelcome = messagesContainer.querySelector('.welcome-message');
            if (existingWelcome) {
                existingWelcome.remove();
            }

            if (chat) {
                if (chat.messages.length === 0) {
                     messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <h2>🎓 Ready for a new academic adventure!</h2>
                            <p>What can I help you with in this session?</p>
                            <div class="suggestions" id="initialSuggestions">
                                <button class="suggestion" onclick="sendSuggestion('Give me study tips')">Give me study tips 📚</button>
                                <button class="suggestion" onclick="sendSuggestion('How to improve grades?')">How to improve grades? 📈</button>
                                <button class="suggestion" onclick="sendSuggestion('Tips for presentations')">Tips for presentations 🎤</button>
                            </div>
                        </div>
                    `;
                } else {
                    chat.messages.forEach(msg => addMessage(msg.content, msg.sender, msg.timestamp, false));
                }
            }
            renderChatHistory();
            scrollToBottom();
            uploadedDocumentText = ''; // Clear uploaded document context when loading a new chat
        }

        async function editChatTitle(event, chatId) {
            event.stopPropagation();
            const chat = chatHistory.find(c => c.id === chatId);
            if (chat) {
                const newTitle = await showPrompt('Edit Chat Title', 'Enter new title for this chat:', chat.title);
                if (newTitle && newTitle.trim() !== '') {
                    chat.title = newTitle.trim();
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderChatHistory();
                } else if (newTitle !== null) { // If user typed but left empty
                    showAlert('Title Empty', 'Chat title cannot be empty.');
                }
            }
        }

        async function deleteChat(event, chatId) {
            event.stopPropagation();
            const confirmed = await showConfirm('Delete Chat', 'Are you sure you want to delete this chat?');
            if (confirmed) {
                chatHistory = chatHistory.filter(c => c.id !== chatId);
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                renderChatHistory();
                if (currentChatId === chatId) {
                    if (chatHistory.length > 0) {
                        loadChat(chatHistory[0].id);
                    } else {
                        startNewChat();
                    }
                }
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = '20px';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendSuggestion(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
        }

        // --- FILE UPLOAD LOGIC ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            addMessage(`Uploaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'user', timestamp, true);

            showTypingIndicator();

            const fileExtension = file.name.split('.').pop().toLowerCase();
            let botResponseText = "Thanks for the upload! I'm processing the file. What specific questions do you have about its content?";

            uploadedDocumentText = ''; // Clear previous document text

            try {
                if (fileExtension === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    uploadedDocumentText = fullText;
                    botResponseText = `Successfully extracted text from your PDF: "${file.name}". I'll use this as context for our conversation. What do you want to know about it?`;
                } else if (fileExtension === 'txt') {
                    const reader = new FileReader();
                    const readPromise = new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            uploadedDocumentText = e.target.result;
                            botResponseText = `Successfully loaded text from "${file.name}". I'll use this as context for our conversation. What do you want to know about it?`;
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                    await readPromise;
                } else {
                    botResponseText = `I received "${file.name}". Currently, I can only extract text from PDF and TXT files for contextual conversations. You can still ask general questions!`;
                }
            } catch (error) {
                console.error("Error handling file upload:", error);
                botResponseText = `Oops! There was an error processing "${file.name}". Please ensure it's a valid PDF or TXT file, or try again. Error: ${error.message}`;
            } finally {
                setTimeout(() => {
                    hideTypingIndicator();
                    const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    addMessage(botResponseText, 'bot', botTimestamp, true);
                    saveCurrentChatState({ content: botResponseText, sender: 'bot', timestamp: botTimestamp });
                }, 1500 + Math.random() * 1000); // Simulate processing time
                event.target.value = ''; // Clear the file input
            }
        }
        // --- END FILE UPLOAD LOGIC ---

        // Gemini API call (broader function for all AI interactions)
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Replace with your actual Gemini API Key
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`; // Using gemini-pro for general chat

        async function getGeminiResponseDirectly(promptContent) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: promptContent }] }]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API call failed: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Gemini API returned no content:", result);
                    return "I didn't get a clear response from the AI. Can you try rephrasing?";
                }
            } catch (error) {
                console.error("Error communicating with Gemini API:", error);
                return `Sorry, I'm having trouble connecting to the AI right now. Please check your internet connection or try again later. (${error.message})`;
            }
        }


        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const userMessage = input.value.trim();

            if (!userMessage) return;

            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            addMessage(userMessage, 'user', timestamp, true);
            saveCurrentChatState({ content: userMessage, sender: 'user', timestamp: timestamp });

            input.value = '';
            input.style.height = '20px';
            adjustTextareaHeight(input);

            showTypingIndicator();

            let promptToSend = userMessage;
            if (uploadedDocumentText) {
                promptToSend = `Based on the following document content:\n\n${uploadedDocumentText}\n\nUser query: ${userMessage}`;
            }

            try {
                const botResponse = await getGeminiResponseDirectly(promptToSend);
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(botResponse, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: botResponse, sender: 'bot', timestamp: botTimestamp });

                if (audioEnabled) {
                    speakText(botResponse);
                }

            } catch (error) {
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(`Error: ${error.message}`, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: `Error: ${error.message}`, sender: 'bot', timestamp: botTimestamp });
            }
        }

        // Summarize Chat History (New Feature)
        document.getElementById('summarizeChatBtn').addEventListener('click', async () => {
            if (chatHistory.length === 0 || !chatHistory.find(c => c.id === currentChatId)) {
                showAlert("No Chat History", "There's no active conversation to summarize yet. Start chatting!");
                return;
            }
            const currentChat = chatHistory.find(c => c.id === currentChatId);
            if (currentChat.messages.length === 0) {
                showAlert("Empty Chat", "This chat has no messages to summarize.");
                return;
            }

            const conversationText = currentChat.messages.map(entry => `${entry.sender === 'user' ? 'User' : 'Bot'}: ${entry.content}`).join('\n\n');
            const prompt = `Please provide a concise summary of the following conversation:\n\n${conversationText}`;

            showTypingIndicator();

            try {
                const summary = await getGeminiResponseDirectly(prompt);
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(`Here's a summary of our current chat:\n\n${summary}`, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: `Here's a summary of our current chat:\n\n${summary}`, sender: 'bot', timestamp: botTimestamp });
            } catch (error) {
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(`Sorry, I couldn't summarize the chat at the moment. Error: ${error.message}`, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: `Sorry, I couldn't summarize the chat at the moment. Error: ${error.message}`, sender: 'bot', timestamp: botTimestamp });
            }
        });

        // Creative Prompt (New Feature)
        document.getElementById('creativePromptBtn').addEventListener('click', async () => {
            const creativePrompt = await showPrompt(
                "Creative Prompt",
                "Tell me what you'd like Campus Connect AI to create! (e.g., 'a short poem about success', 'a simple Python function', 'a motivational quote')",
                "Enter your creative idea..."
            );

            if (!creativePrompt) {
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage("No creative prompt was provided.", 'bot', botTimestamp, true);
                return;
            }

            showTypingIndicator();

            try {
                const generatedText = await getGeminiResponseDirectly(`Generate creative text based on the following idea: ${creativePrompt}`);
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(`Here's what I came up with:\n\n${generatedText}`, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: `Here's what I came up with:\n\n${generatedText}`, sender: 'bot', timestamp: botTimestamp });
            } catch (error) {
                hideTypingIndicator();
                const botTimestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessage(`Sorry, I couldn't generate creative text at the moment. Error: ${error.message}`, 'bot', botTimestamp, true);
                saveCurrentChatState({ content: `Sorry, I couldn't generate creative text at the moment. Error: ${error.message}`, sender: 'bot', timestamp: botTimestamp });
            }
        });


        function saveCurrentChatState(message = null) {
            const currentChat = chatHistory.find(chat => chat.id === currentChatId);
            if (currentChat) {
                if (message) {
                    currentChat.messages.push(message);
                }
                if (currentChat.title === 'New Chat' && currentChat.messages.length > 0) {
                    const firstUserMsg = currentChat.messages.find(msg => msg.sender === 'user');
                    if (firstUserMsg) {
                        currentChat.title = firstUserMsg.content.length > 25 ? firstUserMsg.content.substring(0, 25) + '...' : firstUserMsg.content;
                    }
                }
            }
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderChatHistory(); // Re-render history to update titles
        }


        function addMessage(content, sender, timestamp, animate = true) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            if (!animate) {
                messageDiv.style.animation = 'none';
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? (currentUser ? currentUser.name.charAt(0).toUpperCase() : 'U') : '🤖'}</div>
                <div class="message-content">
                    ${content}
                    <div class="timestamp">${timestamp}</div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messages');
            let typingIndicator = document.getElementById('typing-indicator');
            if (!typingIndicator) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typing-indicator';

                typingDiv.innerHTML = `
                    <div class="typing-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                scrollToBottom();
            }
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Web Speech API for voice input
        let recognition = null;
        let isListening = false;
        const voiceBtn = document.getElementById('voiceBtn');

        function initSpeechRecognition() {
            if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
                voiceBtn.style.display = 'none'; // Hide button if not supported
                console.warn("Speech Recognition not supported in this browser.");
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.style.color = '#FFD700'; // Accent color when listening
                voiceBtn.style.boxShadow = '0 0 10px var(--shadow-color-light)';
            };
            recognition.onend = () => {
                isListening = false;
                voiceBtn.style.color = ''; // Reset color
                voiceBtn.style.boxShadow = '';
            };
            recognition.onerror = (event) => {
                isListening = false;
                voiceBtn.style.color = '';
                voiceBtn.style.boxShadow = '';
                if (event.error === 'not-allowed') {
                    showAlert("Microphone Access Denied", "Please enable microphone access in your browser settings to use voice input.");
                } else {
                    showAlert("Speech Recognition Error", "An error occurred: " + event.error);
                }
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                adjustTextareaHeight(document.getElementById('messageInput'));
            };
        }

        voiceBtn.addEventListener("click", () => {
            if (!recognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Text to Speech
        function speakText(text) {
            if (!window.speechSynthesis || !audioEnabled) return;
            window.speechSynthesis.cancel(); // Stop any current speech
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "en-US"; // Set language
            window.speechSynthesis.speak(utterance);
        }

        // Initial load logic
        window.addEventListener('load', () => {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                document.getElementById('userName').value = currentUser.name;
                document.getElementById('rollNumber').value = currentUser.roll;

                // Hide login page elements
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('loginPageBackground').style.display = 'none'; // Hide falling squares

                // Show mood/topic modal
                document.getElementById('modalUserName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('moodTopicModal').style.display = 'flex';

                // Ensure chatApp and Three.js canvas are hidden on load (will be shown after modal)
                document.getElementById('chatApp').style.display = 'none';
                document.getElementById('threeJsCanvas').style.display = 'none';

            } else {
                // Only show the login page if no user is stored
                document.getElementById('loginPage').style.display = 'flex'; // Show login page
                document.getElementById('loginPageBackground').style.display = 'block'; // Show falling squares for login
                createFallingSquares(); // Start square animation for login

                document.getElementById('chatApp').style.display = 'none'; // Hide chat app
                document.getElementById('threeJsCanvas').style.display = 'none'; // Hide Three.js canvas
                document.getElementById('moodTopicModal').style.display = 'none'; // Ensure modal is hidden
            }

            renderChatHistory();
            initSpeechRecognition(); // Initialize speech recognition
        });
    </script>
</body>
</html>